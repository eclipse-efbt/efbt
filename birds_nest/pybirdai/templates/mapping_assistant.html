{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<h1>{{ page_title }}</h1>

{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<div class="description">
    <p>The Mapping Assistant helps you generate mapping proposals based on combinations and existing mapping patterns.</p>
    <p>Choose your analysis scope: individual combinations, templates (cubes), or entire frameworks.</p>
</div>

<form method="post" action="{% url 'pybirdai:mapping_assistant' %}">
    {% csrf_token %}

    <div class="form-section">
        <h2>Analysis Mode</h2>
        <p>Select the scope of your mapping analysis:</p>

        <div class="mode-selection">
            <label class="mode-option">
                <input type="radio" name="mode" value="combination" checked onchange="updateModeDisplay()">
                <strong>Individual Combinations</strong> - Select specific combinations to analyze
            </label>

            <label class="mode-option">
                <input type="radio" name="mode" value="template" onchange="updateModeDisplay()">
                <strong>By Template</strong> - Analyze all combinations within selected templates/cubes
            </label>

            <label class="mode-option">
                <input type="radio" name="mode" value="framework" onchange="updateModeDisplay()">
                <strong>By Framework</strong> - Analyze all combinations across entire frameworks with consistency
            </label>
        </div>
    </div>

    <div class="form-section" id="combination-section">
        <h2>Select Combinations</h2>
        <p>Choose one or more combinations to generate mapping proposals for:</p>

        <div class="select-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
            {% for combination in combinations %}
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" name="combinations" value="{{ combination.combination_id }}">
                    {{ combination.combination_id }}
                    {% if combination.name %}- {{ combination.name }}{% endif %}
                    {% if combination.description %}({{ combination.description }}){% endif %}
                </label>
            </div>
            {% endfor %}
        </div>

        <div class="select-all-controls" style="margin-top: 10px;">
            <button type="button" onclick="selectAll('combinations')" class="btn btn-secondary">Select All</button>
            <button type="button" onclick="deselectAll('combinations')" class="btn btn-secondary">Deselect All</button>
        </div>
    </div>

    <div class="form-section" id="template-section" style="display: none;">
        <h2>Select Templates</h2>
        <p>Choose one or more templates/cubes to analyze all their combinations:</p>

        <div class="select-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
            {% for cube in cubes %}
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" name="templates" value="{{ cube.cube_id }}">
                    {{ cube.cube_id }}
                    {% if cube.name %}- {{ cube.name }}{% endif %}
                    {% if cube.framework_id %}(Framework: {{ cube.framework_id }}){% endif %}
                </label>
            </div>
            {% endfor %}
        </div>

        <div class="select-all-controls" style="margin-top: 10px;">
            <button type="button" onclick="selectAll('templates')" class="btn btn-secondary">Select All</button>
            <button type="button" onclick="deselectAll('templates')" class="btn btn-secondary">Deselect All</button>
        </div>
    </div>

    <div class="form-section" id="framework-section" style="display: none;">
        <h2>Select Frameworks</h2>
        <p>Choose one or more frameworks to analyze all combinations across all their templates:</p>

        <div class="select-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
            {% for framework in frameworks %}
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" name="frameworks" value="{{ framework.framework_id }}">
                    {{ framework.framework_id }}
                    {% if framework.name %}- {{ framework.name }}{% endif %}
                    {% if framework.description %}<br><small>{{ framework.description }}</small>{% endif %}
                </label>
            </div>
            {% endfor %}
        </div>

        <div class="select-all-controls" style="margin-top: 10px;">
            <button type="button" onclick="selectAll('frameworks')" class="btn btn-secondary">Select All</button>
            <button type="button" onclick="deselectAll('frameworks')" class="btn btn-secondary">Deselect All</button>
        </div>

        <div class="framework-options" style="margin-top: 15px;">
            <label>
                <input type="checkbox" name="ensure_consistency" checked>
                <strong>Ensure mapping consistency across templates</strong> - Resolve conflicts by selecting highest confidence mappings
            </label>
        </div>
    </div>

    <div class="form-section">
        <h2>Variable Mapping Filter (Optional)</h2>
        <p>Optionally select variable mappings to filter the proposals:</p>

        <div class="select-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
            {% for vm in variable_mappings %}
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" name="variable_mappings" value="{{ vm.variable_mapping_id }}">
                    {{ vm.variable_mapping_id }}
                    {% if vm.name %}- {{ vm.name }}{% endif %}
                </label>
            </div>
            {% endfor %}
        </div>

        <div class="select-all-controls" style="margin-top: 10px;">
            <button type="button" onclick="selectAll('variable_mappings')" class="btn btn-secondary">Select All</button>
            <button type="button" onclick="deselectAll('variable_mappings')" class="btn btn-secondary">Deselect All</button>
        </div>
    </div>

    <div class="form-section">
        <h2>Confidence Threshold</h2>
        <p>Set the minimum confidence score for proposals (0.0 - 1.0):</p>
        <input type="number" name="confidence_threshold" min="0" max="1" step="0.1" value="0.7" style="width: 100px;">
    </div>

    <div class="form-actions" style="margin-top: 20px;">
        <button type="submit" class="btn btn-primary">Generate Proposals</button>
        <a href="{% url 'pybirdai:home' %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
function selectAll(name) {
    var checkboxes = document.getElementsByName(name);
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = true;
    }
}

function deselectAll(name) {
    var checkboxes = document.getElementsByName(name);
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }
}

function updateModeDisplay() {
    var mode = document.querySelector('input[name="mode"]:checked').value;

    // Hide all sections
    document.getElementById('combination-section').style.display = 'none';
    document.getElementById('template-section').style.display = 'none';
    document.getElementById('framework-section').style.display = 'none';

    // Show the selected section
    if (mode === 'combination') {
        document.getElementById('combination-section').style.display = 'block';
    } else if (mode === 'template') {
        document.getElementById('template-section').style.display = 'block';
    } else if (mode === 'framework') {
        document.getElementById('framework-section').style.display = 'block';
    }
}
</script>

<style>
.form-section {
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f5f5f5;
    border-radius: 5px;
}

.mode-selection {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.mode-option {
    display: flex;
    align-items: flex-start;
    padding: 15px;
    background-color: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.2s, background-color 0.2s;
}

.mode-option:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.mode-option input[type="radio"] {
    margin-right: 12px;
    margin-top: 2px;
}

.mode-option input[type="radio"]:checked + strong {
    color: #007bff;
}

.framework-options {
    background-color: #e9ecef;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.form-section h2 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #333;
}

.checkbox-item {
    padding: 5px 0;
}

.checkbox-item:hover {
    background-color: #e9e9e9;
}

.checkbox-item input[type="checkbox"] {
    margin-right: 10px;
}

.btn {
    padding: 10px 20px;
    margin-right: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.description {
    background-color: #e9ecef;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.messages {
    list-style: none;
    padding: 0;
}

.messages li {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
}

.messages .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.messages .error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.messages .warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}
</style>

{% endblock %}
