{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<h1>{{ page_title }}</h1>

{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<div class="summary">
    <h2>Summary</h2>
    <p>Total combinations analyzed: <strong>{{ proposals.summary.total_combinations }}</strong></p>
    <p>Combinations with proposals: <strong>{{ proposals.summary.combinations_with_proposals }}</strong></p>
    <p>Total proposals generated: <strong>{{ proposals.summary.total_proposals }}</strong></p>
</div>

<form method="post" action="{% url 'mapping_assistant_review' %}" id="proposalForm">
    {% csrf_token %}
    <input type="hidden" name="accepted_proposals" id="accepted_proposals" value="[]">
    
    {% for combination_id, proposal_list in proposals.proposals.items %}
    <div class="combination-section">
        <h3>Combination: {{ combination_id }}</h3>
        
        {% if proposal_list %}
        <div class="table-container">
            <table class="proposals-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">Accept</th>
                        <th>Source Variable</th>
                        <th>Source Member</th>
                        <th>Target Variable</th>
                        <th>Target Member</th>
                        <th>Confidence</th>
                        <th>Mapping ID</th>
                        <th>Row</th>
                        <th>Reasoning</th>
                    </tr>
                </thead>
                <tbody>
                    {% for proposal in proposal_list %}
                    <tr>
                        <td style="text-align: center;">
                            <input type="checkbox" 
                                   class="proposal-checkbox" 
                                   data-source-variable="{{ proposal.source_variable_id }}"
                                   data-source-member="{{ proposal.source_member_id }}"
                                   data-target-variable="{{ proposal.target_variable_id }}"
                                   data-target-member="{{ proposal.target_member_id }}"
                                   data-mapping-id="{{ proposal.member_mapping_id }}"
                                   data-mapping-row="{{ proposal.member_mapping_row }}"
                                   data-confidence="{{ proposal.confidence_score }}"
                                   data-combination="{{ combination_id }}">
                        </td>
                        <td>{{ proposal.source_variable_id }}</td>
                        <td>{{ proposal.source_member_id }}</td>
                        <td>{{ proposal.target_variable_id }}</td>
                        <td>{{ proposal.target_member_id }}</td>
                        <td>{{ proposal.confidence_score|floatformat:2 }}</td>
                        <td>{{ proposal.member_mapping_id }}</td>
                        <td>{{ proposal.member_mapping_row }}</td>
                        <td>{{ proposal.reasoning }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="combination-controls">
            <button type="button" onclick="selectAllInCombination('{{ combination_id }}')" class="btn btn-sm">Select All</button>
            <button type="button" onclick="deselectAllInCombination('{{ combination_id }}')" class="btn btn-sm">Deselect All</button>
        </div>
        {% else %}
        <p class="no-proposals">No proposals generated for this combination.</p>
        {% endif %}
    </div>
    {% endfor %}
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary" onclick="prepareSubmit()">Accept Selected Proposals</button>
        <a href="{% url 'mapping_assistant' %}" class="btn btn-secondary">Back to Selection</a>
    </div>
</form>

<script>
function selectAllInCombination(combinationId) {
    var checkboxes = document.querySelectorAll(`input[data-combination="${combinationId}"]`);
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = true;
    });
}

function deselectAllInCombination(combinationId) {
    var checkboxes = document.querySelectorAll(`input[data-combination="${combinationId}"]`);
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = false;
    });
}

function prepareSubmit() {
    var acceptedProposals = [];
    var checkboxes = document.querySelectorAll('.proposal-checkbox:checked');
    
    checkboxes.forEach(function(checkbox) {
        var proposal = {
            source_variable_id: checkbox.getAttribute('data-source-variable'),
            source_member_id: checkbox.getAttribute('data-source-member'),
            target_variable_id: checkbox.getAttribute('data-target-variable'),
            target_member_id: checkbox.getAttribute('data-target-member'),
            member_mapping_id: checkbox.getAttribute('data-mapping-id'),
            member_mapping_row: checkbox.getAttribute('data-mapping-row'),
            confidence_score: parseFloat(checkbox.getAttribute('data-confidence'))
        };
        acceptedProposals.push(proposal);
    });
    
    document.getElementById('accepted_proposals').value = JSON.stringify(acceptedProposals);
}
</script>

<style>
.summary {
    background-color: #e9ecef;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.summary h2 {
    margin-top: 0;
}

.combination-section {
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.combination-section h3 {
    margin-top: 0;
    color: #495057;
}

.table-container {
    overflow-x: auto;
    margin-bottom: 15px;
}

.proposals-table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
}

.proposals-table th,
.proposals-table td {
    padding: 8px 12px;
    text-align: left;
    border: 1px solid #dee2e6;
}

.proposals-table th {
    background-color: #f1f3f5;
    font-weight: bold;
}

.proposals-table tr:hover {
    background-color: #f8f9fa;
}

.combination-controls {
    margin-top: 10px;
}

.no-proposals {
    color: #6c757d;
    font-style: italic;
}

.form-actions {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 5px;
    text-align: center;
}

.btn {
    padding: 10px 20px;
    margin: 0 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 14px;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.messages {
    list-style: none;
    padding: 0;
}

.messages li {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
}

.messages .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.messages .error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.messages .warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}
</style>

{% endblock %}