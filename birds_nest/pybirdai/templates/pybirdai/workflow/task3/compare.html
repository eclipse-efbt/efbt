{% extends "pybirdai/workflow/base.html" %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">›</span>
<a href="{% url 'pybirdai:workflow_task' task_number=3 operation='do' %}">Task 3: SMCubes Core Creation</a>
<span class="breadcrumb-separator">›</span>
<span>Compare</span>
{% endblock %}

{% block workflow_content %}
<div class="task-content">
    <h1>Task 3: SMCubes Core Creation - Compare</h1>
    
    <h2>Comparison with Previous Version</h2>
    
    <div class="comparison-controls">
        <label for="baseline-version">Compare with:</label>
        <select id="baseline-version" class="form-control" style="width: auto; display: inline-block;">
            <option value="previous">Previous Version</option>
            <option value="reference">Reference Model</option>
            <option value="date">Specific Date</option>
        </select>
        <button class="btn btn-sm btn-primary" onclick="refreshComparison()">Refresh</button>
    </div>
    
    <div class="comparison-grid">
        <div class="comparison-section">
            <h3>Hierarchy Changes</h3>
            
            <div class="change-summary">
                <div class="change-item added">
                    <span class="change-icon">+</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.hierarchies_added|default:0 }} Added</strong>
                        <p>New hierarchies in current version</p>
                    </div>
                </div>
                
                <div class="change-item modified">
                    <span class="change-icon">~</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.hierarchies_modified|default:0 }} Modified</strong>
                        <p>Hierarchies with structural changes</p>
                    </div>
                </div>
                
                <div class="change-item removed">
                    <span class="change-icon">-</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.hierarchies_removed|default:0 }} Removed</strong>
                        <p>Hierarchies no longer present</p>
                    </div>
                </div>
            </div>
            
            {% if comparison_data.hierarchy_changes %}
            <div class="change-details-list">
                <h4>Detailed Changes:</h4>
                <div class="change-list">
                    {% for change in comparison_data.hierarchy_changes %}
                    <div class="change-entry">
                        <span class="change-type {{ change.type }}">{{ change.type|upper }}</span>
                        <span class="change-name">{{ change.name }}</span>
                        {% if change.details %}
                        <span class="change-description">{{ change.details }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="comparison-section">
            <h3>Semantic Integration Changes</h3>
            
            <div class="change-summary">
                <div class="change-item added">
                    <span class="change-icon">+</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.semantic_added|default:0 }} Added</strong>
                        <p>New integration rules</p>
                    </div>
                </div>
                
                <div class="change-item modified">
                    <span class="change-icon">~</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.semantic_modified|default:0 }} Modified</strong>
                        <p>Updated mapping definitions</p>
                    </div>
                </div>
                
                <div class="change-item removed">
                    <span class="change-icon">-</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.semantic_removed|default:0 }} Removed</strong>
                        <p>Deleted integrations</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="comparison-section">
            <h3>Cube Structure Changes</h3>
            
            <div class="change-summary">
                <div class="change-item added">
                    <span class="change-icon">+</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.cubes_added|default:0 }} Added</strong>
                        <p>New cube definitions</p>
                    </div>
                </div>
                
                <div class="change-item modified">
                    <span class="change-icon">~</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.cubes_modified|default:0 }} Modified</strong>
                        <p>Updated dimensions or measures</p>
                    </div>
                </div>
                
                <div class="change-item removed">
                    <span class="change-icon">-</span>
                    <div class="change-details">
                        <strong>{{ comparison_data.cubes_removed|default:0 }} Removed</strong>
                        <p>Deleted cube structures</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="impact-analysis">
        <h2>Impact Analysis</h2>
        
        <div class="impact-grid">
            <div class="impact-card">
                <h3>Downstream Effects</h3>
                <p>Changes in this task will affect:</p>
                <ul>
                    <li>Task 4: SMCubes Transformation Rules ({{ comparison_data.rules_affected|default:0 }} rules)</li>
                    <li>Task 5: Python Code Generation ({{ comparison_data.code_files_affected|default:0 }} files)</li>
                    <li>Task 6: Test Suite ({{ comparison_data.tests_affected|default:0 }} test cases)</li>
                </ul>
            </div>
            
            <div class="impact-card">
                <h3>Data Quality Impact</h3>
                <ul>
                    <li>New validations required: {{ comparison_data.new_validations|default:0 }}</li>
                    <li>Mapping coverage change: {{ comparison_data.coverage_change|default:"+0%" }}</li>
                    <li>Potential data issues: {{ comparison_data.potential_issues|default:0 }}</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="form-actions" style="margin-top: 30px;">
        <form method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" name="approve_changes" class="btn btn-success">Approve Changes</button>
        </form>
        <button class="btn btn-warning" onclick="exportComparisonReport()">Export Report</button>
        <a href="{% url 'pybirdai:workflow_task' task_number=4 operation='do' %}" class="btn btn-primary">Proceed to Task 4</a>
        <a href="{% url 'pybirdai:workflow_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</div>

<style>
.comparison-controls {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.comparison-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.comparison-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.comparison-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
}

.change-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.change-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-radius: 6px;
    background: #f8f9fa;
}

.change-item.added {
    background: #d1e7dd;
}

.change-item.modified {
    background: #fff3cd;
}

.change-item.removed {
    background: #f8d7da;
}

.change-icon {
    font-size: 24px;
    font-weight: bold;
    margin-right: 10px;
    width: 30px;
    text-align: center;
}

.change-item.added .change-icon {
    color: #0f5132;
}

.change-item.modified .change-icon {
    color: #664d03;
}

.change-item.removed .change-icon {
    color: #842029;
}

.change-details strong {
    display: block;
    margin-bottom: 2px;
}

.change-details p {
    margin: 0;
    font-size: 12px;
    color: #6c757d;
}

.change-details-list {
    margin-top: 20px;
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.change-list {
    max-height: 200px;
    overflow-y: auto;
}

.change-entry {
    display: flex;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
}

.change-type {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    margin-right: 10px;
    min-width: 60px;
    text-align: center;
}

.change-type.added {
    background: #198754;
    color: white;
}

.change-type.modified {
    background: #ffc107;
    color: #000;
}

.change-type.removed {
    background: #dc3545;
    color: white;
}

.change-name {
    font-weight: 500;
    margin-right: 10px;
}

.change-description {
    color: #6c757d;
    font-size: 12px;
}

.impact-analysis {
    margin-top: 30px;
}

.impact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.impact-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.impact-card h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #495057;
}

.impact-card ul {
    margin: 0;
    padding-left: 20px;
}
</style>

<script>
function refreshComparison() {
    // Implementation for refreshing comparison based on selected baseline
    const baseline = document.getElementById('baseline-version').value;
    // Make AJAX call to refresh comparison data
    console.log('Refreshing comparison with baseline:', baseline);
}

function exportComparisonReport() {
    // Implementation for exporting comparison report
    window.open('{% url "pybirdai:workflow_task" task_number=3 operation="compare" %}?export=true', '_blank');
}
</script>
{% endblock %}