{% extends "pybirdai/workflow/base.html" %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">›</span>
<a href="{% url 'pybirdai:workflow_task' task_number=2 operation='do' %}"
    >Task 2: Database Creation</a
>
<span class="breadcrumb-separator">›</span>
<span>Do</span>
{% endblock %}

{% block workflow_content %}
<div class="task-content">
    <h1>Task 2: Database Creation - Do</h1>

    {% if task_execution.status == 'completed' %}
    <div class="alert alert-success">
        <strong>✓ Task Completed</strong>
        <p>
            Database has been created successfully. You can proceed to the
            Review step.
        </p>
        <a
            href="{% url 'pybirdai:workflow_task' task_number=2 operation='review' %}"
            class="btn btn-primary"
            >Go to Review</a
        >
    </div>
    {% elif task_execution.status == 'paused' %}
    <div class="alert alert-warning">
        <strong>⏸️ Server Restart Required</strong>
        <p>Django models have been created. Please follow these steps:</p>
        <ol>
            <li>Stop the Django development server (Ctrl+C in terminal)</li>
            <li>Run migrations: <code>python manage.py migrate</code></li>
            <li>Restart the server: <code>python manage.py runserver</code></li>
            <li>Return to this page and click "Continue After Restart"</li>
        </ol>

        <form method="post" style="margin-top: 20px">
            {% csrf_token %}
            <input type="hidden" name="action" value="continue" />
            <button type="submit" class="btn btn-primary">
                Continue After Restart
            </button>
        </form>
    </div>
    {% elif task_execution.status == 'failed' %}
    <div class="alert alert-danger">
        <strong>✗ Task Failed</strong>
        <p>{{ task_execution.error_message }}</p>
        <p>Please fix the issues and try again.</p>
    </div>
    {% endif %}

    <h2>Database Creation Steps</h2>

    <div class="step-cards">
        <div class="step-card">
            <h3>Step 1: Model Generation</h3>
            <p>Generate Django models from the imported LDM/EIL data model</p>
            {% if task_execution.status == 'pending' %}
            <span class="status-badge pending">Pending</span>
            <button
                type="button"
                class="btn btn-sm btn-primary substep-btn"
                data-substep="start"
            >
                Run Model Generation
            </button>
            {% elif task_execution.execution_data.model_generation_complete %}
            <span class="status-badge completed">✓ Completed</span>
            {% else %}
            <span class="status-badge running">In Progress</span>
            {% endif %}
        </div>

        <div class="step-card">
            <h3>Step 2: Database Migration</h3>
            <p>Create database tables and apply migrations</p>
            {% if task_execution.status == 'pending' or task_execution.status == 'paused' %}
            <span class="status-badge pending">Requires Restart</span>
            {% if task_execution.status == 'paused' %}
            <button
                type="button"
                class="btn btn-sm btn-success substep-btn"
                data-substep="continue"
            >
                Run Continue After Restart
            </button>
            {% endif %}
            {% elif task_execution.execution_data.migration_complete %}
            <span class="status-badge completed">✓ Completed</span>
            {% else %}
            <span class="status-badge pending">Pending</span>
            {% endif %}
        </div>

        <div class="step-card">
            <h3>Step 3: Initial Data Setup</h3>
            <p>Populate initial metadata and configure database</p>
            {% if task_execution.execution_data.initial_data_complete %}
            <span class="status-badge completed">✓ Completed</span>
            {% else %}
            <span class="status-badge pending">Pending</span>
            {% endif %}
        </div>
    </div>

    {% if task_execution.status == 'pending' %}
    <form method="post" style="margin-top: 30px">
        {% csrf_token %}
        <input type="hidden" name="action" value="start" />

        <div class="alert alert-info">
            <h4>Important Notes:</h4>
            <ul>
                <li>
                    This process will create Django models based on your
                    imported data model
                </li>
                <li>
                    A server restart will be required to apply database
                    migrations
                </li>
                <li>
                    Ensure you have completed Task 1 (Resource Download) before
                    proceeding
                </li>
                <li>
                    The process is fully automated but requires manual server
                    restart
                </li>
            </ul>
        </div>

        <button type="submit" class="btn btn-primary">
            Start Database Creation
        </button>
        <a href="{% url 'pybirdai:workflow_dashboard' %}" class="btn btn-secondary" >Cancel</a>
    </form>
    {% endif %}
</div>

<style>
    .step-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .step-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .step-card h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #495057;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-top: 10px;
    }

    .status-badge.pending {
        background-color: #e9ecef;
        color: #6c757d;
    }

    .status-badge.running {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-badge.completed {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .substep-btn {
        margin-top: 10px;
        margin-left: 10px;
    }

    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }

    code {
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
    }
</style>

<script>
    // Handle individual substep buttons
    document.addEventListener("DOMContentLoaded", function () {
        const substepButtons = document.querySelectorAll(".substep-btn");
        substepButtons.forEach((button) => {
            button.addEventListener("click", function () {
                const substepName = this.getAttribute("data-substep");
                const taskNumber = 2;

                // Show processing message
                alert("Running substep: " + substepName);

                // Disable button
                this.disabled = true;
                this.innerHTML =
                    '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...';

                // Get CSRF token
                const csrfToken = document.querySelector(
                    "[name=csrfmiddlewaretoken]",
                ).value;

                // Submit substep via AJAX
                fetch(
                    `/pybirdai/workflow/task/${taskNumber}/substep/${substepName}/`,
                    {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": csrfToken,
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body:
                            "csrfmiddlewaretoken=" +
                            encodeURIComponent(csrfToken),
                    },
                )
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            alert(
                                "Success: " +
                                    (data.message ||
                                        "Substep completed successfully."),
                            );
                            // Refresh page after 2 seconds to show updated status
                            setTimeout(function () {
                                location.reload();
                            }, 2000);
                        } else {
                            alert(
                                "Error: " + (data.message || "Substep failed."),
                            );
                            this.disabled = false;
                            this.innerHTML =
                                "Run " +
                                substepName.replace(/\b\w/g, (l) =>
                                    l.toUpperCase(),
                                );
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        alert(
                            "Error: An unexpected error occurred running the substep.",
                        );
                        this.disabled = false;
                        this.innerHTML =
                            "Run " +
                            substepName.replace(/\b\w/g, (l) =>
                                l.toUpperCase(),
                            );
                    });
            });
        });
    });
</script>

{% endblock %}
