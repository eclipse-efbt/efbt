{% extends "pybirdai/workflow/base.html" %}

{% block workflow_content %}
<h1>BIRD Data Processing Workflow</h1>

<!-- Configuration Section -->
{% include 'pybirdai/workflow/configuration_section.html' %}

<!-- Database Status Notice -->
{% if not database_ready %}
<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
    <h3 style="color: #d68910; margin-bottom: 10px;">‚ö†Ô∏è Database Not Available</h3>
    <p style="margin-bottom: 10px; color: #856404;">
        The BIRD database has not been created yet. To get started:
    </p>
    <ol style="color: #856404; margin-left: 20px;">
        <li>Configure your data sources above</li>
        <li>Click "Setup Database (Tasks 1-2)" to create the database</li>
        <li>Once complete, the full workflow interface will be available</li>
    </ol>
</div>
{% endif %}

<!-- Progress Bar -->
<div class="progress-bar">
    <div class="progress-fill" style="width: {{ progress }}%;">
        {{ progress }}% Complete
    </div>
</div>

<!-- Task Grid -->
<div class="task-grid">
    <div class="task-card">
        <h3>Task</h3>
    </div>
    <div class="task-card">
        <h3>Do</h3>
    </div>
    <div class="task-card">
        <h3>Review</h3>
    </div>
    <div class="task-card">
        <h3>Compare</h3>
    </div>
    
    {% if database_ready and task_grid %}
        {% for task in task_grid %}
        <div class="task-card {% if workflow_session and forloop.counter == workflow_session.current_task %}active{% endif %}">
            <h3>{{ forloop.counter }}. {{ task.task_name }}</h3>
        </div>
        
        <div class="task-card">
            <a href="{% url 'pybirdai:workflow_task' task_number=task.task_number operation='do' %}" 
               class="operation-btn {{ task.operations.do.status }}">
                Do
                {% if task.operations.do.status == 'completed' %}‚úì{% endif %}
                {% if task.operations.do.status == 'running' %}üîÑ{% endif %}
                {% if task.operations.do.status == 'failed' %}‚úó{% endif %}
                {% if task.operations.do.status == 'paused' %}‚è∏Ô∏è{% endif %}
            </a>
        </div>
        
        <div class="task-card">
            <a href="{% url 'pybirdai:workflow_task' task_number=task.task_number operation='review' %}" 
               class="operation-btn {{ task.operations.review.status }}">
                Review
                {% if task.operations.review.status == 'completed' %}‚úì{% endif %}
            </a>
        </div>
        
        <div class="task-card">
            <a href="{% url 'pybirdai:workflow_task' task_number=task.task_number operation='compare' %}" 
               class="operation-btn {{ task.operations.compare.status }}">
                Compare
                {% if task.operations.compare.status == 'completed' %}‚úì{% endif %}
            </a>
        </div>
        {% endfor %}
    {% else %}
        <!-- Default task grid when database is not available -->
        {% for i in "123456" %}
        <div class="task-card">
            <h3>{{ forloop.counter }}. 
                {% if forloop.counter == 1 %}Resource Download
                {% elif forloop.counter == 2 %}Database Creation
                {% elif forloop.counter == 3 %}SMCubes Core Creation
                {% elif forloop.counter == 4 %}SMCubes Transformation Rules
                {% elif forloop.counter == 5 %}Python Transformation Rules
                {% elif forloop.counter == 6 %}Full Execution
                {% endif %}
            </h3>
        </div>
        
        <div class="task-card">
            <span class="operation-btn pending">Do ‚è≥</span>
        </div>
        
        <div class="task-card">
            <span class="operation-btn pending">Review ‚è≥</span>
        </div>
        
        <div class="task-card">
            <span class="operation-btn pending">Compare ‚è≥</span>
        </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="task-content">
    <h2>Quick Actions</h2>
    
    <div style="display: flex; gap: 20px; margin-top: 20px;">
        <div style="flex: 1;">
            <h3>Database Setup</h3>
            {% if migration_ready %}
                <p><strong>Step 2:</strong> Ready to run database migrations</p>
                <form id="migration-form" method="post" action="{% url 'pybirdai:workflow_run_migrations' %}">
                    {% csrf_token %}
                    <button type="submit" id="migration-btn" class="btn btn-warning" style="width: 100%; margin-bottom: 10px;">
                        Run Migrations (Step 2)
                    </button>
                </form>
                <div id="migration-status" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px;"></div>
                <p><small>Admin files were updated and server restarted. Click above to complete database setup.</small></p>
            {% else %}
                <p><strong>Step 1:</strong> Download resources and prepare database</p>
                <form id="database-setup-form" method="post" action="{% url 'pybirdai:workflow_database_setup' %}">
                    {% csrf_token %}
                    <button type="submit" id="database-setup-btn" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">
                        Setup Database (Tasks 1-2)
                    </button>
                </form>
                <div id="database-setup-status" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px;"></div>
            {% endif %}
        </div>
        
        <div style="flex: 1;">
            <h3>Automode Execution</h3>
            <p>Run tasks automatically from Task 3 up to selected point</p>
            <form id="automode-form" method="post" action="{% url 'pybirdai:workflow_automode' %}">
                {% csrf_token %}
                <select name="target_task" class="form-control" style="margin-bottom: 10px;">
                    <option value="3">Task 3: SMCubes Core Creation</option>
                    <option value="4">Task 4: SMCubes Transformation Rules</option>
                    <option value="5">Task 5: Python Transformation Rules</option>
                    <option value="6" selected>Task 6: Full Execution</option>
                </select>
                <button type="submit" id="automode-btn" class="btn btn-primary">Run Automode (from Task 3)</button>
            </form>
            <div id="automode-status" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px;"></div>
        </div>
        
        <div style="flex: 1;">
            <h3>System Status</h3>
            <ul>
                <li>Database: {% if database_ready %}‚úÖ Ready{% else %}‚ùå Not created{% endif %}</li>
                <li>Configuration: {% if config %}‚úÖ Configured{% else %}‚ùå Not configured{% endif %}</li>
                {% if workflow_session %}
                    <li>Session ID: {{ workflow_session.session_id|slice:":8" }}...</li>
                {% else %}
                    <li>Session: ‚è≥ Waiting for database</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="task-content" style="margin-top: 20px;">
    <h3>Status Legend</h3>
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <span><span class="operation-btn" style="padding: 2px 8px;">‚è≥</span> Pending</span>
        <span><span class="operation-btn running" style="padding: 2px 8px;">üîÑ</span> Running</span>
        <span><span class="operation-btn completed" style="padding: 2px 8px;">‚úì</span> Completed</span>
        <span><span class="operation-btn failed" style="padding: 2px 8px;">‚úó</span> Failed</span>
        <span><span class="operation-btn paused" style="padding: 2px 8px;">‚è∏Ô∏è</span> Paused</span>
        <span><span class="operation-btn invalidated" style="padding: 2px 8px;">üîÑ</span> Invalidated</span>
    </div>
</div>
{% endblock %}

{% block workflow_js %}
// Auto-refresh every 5 seconds if any task is running
var hasRunningTasks = false;
{% if database_ready and task_grid %}
    {% for task in task_grid %}
        {% if task.operations.do.status == 'running' or task.operations.review.status == 'running' or task.operations.compare.status == 'running' %}
        hasRunningTasks = true;
        {% endif %}
    {% endfor %}
{% endif %}

if (hasRunningTasks) {
    setInterval(function() {
        location.reload();
    }, 5000);
}

// Database Setup Form Handler
document.getElementById('database-setup-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('database-setup-btn');
    const statusDiv = document.getElementById('database-setup-status');
    const formData = new FormData(this);
    
    btn.disabled = true;
    btn.textContent = 'Running...';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#e3f2fd';
    statusDiv.style.color = '#1976d2';
    statusDiv.textContent = 'Setting up database (Tasks 1-2)...';
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        statusDiv.style.display = 'block';
        if (data.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            
            let message = data.message + '<br>Completed tasks: ' + data.completed_tasks.join(', ');
            
            // Check if server restart is required
            if (data.requires_restart) {
                message += '<br><br><strong>‚ö†Ô∏è Server Restart Notice (Step 1 Complete):</strong><br>';
                message += 'Admin files have been updated successfully.<br>';
                message += 'Django is restarting to load the new model definitions.<br>';
                message += 'After restart, click "Run Migrations (Step 2)" to complete database setup.<br>';
                message += '<em>Do not close this browser tab during the restart process.</em>';
                
                // Show countdown and auto-refresh after restart time
                let countdown = 45; // 45 seconds should be enough for restart
                statusDiv.innerHTML = message + '<br><br>Auto-refresh in: <span id="countdown">' + countdown + '</span> seconds';
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    const countdownElement = document.getElementById('countdown');
                    if (countdownElement) {
                        countdownElement.textContent = countdown;
                    }
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        statusDiv.innerHTML = message + '<br><br>Refreshing page...';
                        location.reload();
                    }
                }, 1000);
            } else {
                statusDiv.innerHTML = message;
                // Normal refresh for non-restart scenarios
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = 'Error: ' + data.message + 
                (data.errors.length > 0 ? '<br>Errors: ' + JSON.stringify(data.errors) : '');
        }
    })
    .catch(error => {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.textContent = 'Error: ' + error.message;
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Setup Database (Tasks 1-2)';
    });
});

// Migration Form Handler (Step 2)
document.addEventListener('DOMContentLoaded', function() {
    const migrationForm = document.getElementById('migration-form');
    if (migrationForm) {
        migrationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('migration-btn');
            const statusDiv = document.getElementById('migration-status');
            const formData = new FormData(this);
            
            btn.disabled = true;
            btn.textContent = 'Running Migrations...';
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e3f2fd';
            statusDiv.style.color = '#1976d2';
            statusDiv.textContent = 'Running database migrations in subprocess. This may take several minutes...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'block';
                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = 'Database migrations completed successfully!<br>The database is now ready for use.';
                    
                    // Refresh page after success to show updated database status
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = 'Migration failed: ' + 
                        (data.errors.length > 0 ? JSON.stringify(data.errors) : 'Unknown error');
                }
            })
            .catch(error => {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = 'Error: ' + error.message;
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Run Migrations (Step 2)';
            });
        });
    }
});

// Automode Form Handler
document.getElementById('automode-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('automode-btn');
    const statusDiv = document.getElementById('automode-status');
    const formData = new FormData(this);
    const targetTask = formData.get('target_task');
    
    btn.disabled = true;
    btn.textContent = 'Running...';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#e3f2fd';
    statusDiv.style.color = '#1976d2';
    statusDiv.textContent = `Running automode tasks 3-${targetTask}...`;
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        statusDiv.style.display = 'block';
        if (data.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = 'Automode completed successfully!<br>Completed tasks: ' + data.completed_tasks.join(', ');
            
            // Refresh page after success to show updated task status
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = 'Automode failed: ' + 
                (data.errors.length > 0 ? JSON.stringify(data.errors) : 'Unknown error');
        }
    })
    .catch(error => {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.textContent = 'Error: ' + error.message;
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Run Automode (from Task 3)';
    });
});
{% endblock %}