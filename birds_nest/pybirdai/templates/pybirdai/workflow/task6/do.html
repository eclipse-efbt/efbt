{% extends "pybirdai/workflow/base.html" %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">‚Ä∫</span>
<a href="{% url 'pybirdai:workflow_task' task_number=6 operation='do' %}">Task 6: Full Execution with Test Suite</a>
<span class="breadcrumb-separator">‚Ä∫</span>
<span>Do</span>
{% endblock %}

{% block workflow_content %}
<div class="task-content">
    <h1>Task 6: Full Execution with Test Suite - Do</h1>
    
    {% if task_execution.status == 'completed' %}
    <div class="alert alert-success">
        <strong>‚úì Task Completed</strong>
        <p>Full execution completed successfully!</p>
        <div class="execution-summary">
            <div class="summary-item">
                <strong>Tests Run:</strong> {{ task_execution.execution_data.total_tests|default:0 }}
            </div>
            <div class="summary-item">
                <strong>Tests Passed:</strong> {{ task_execution.execution_data.tests_passed|default:0 }}
            </div>
            <div class="summary-item">
                <strong>Tests Failed:</strong> {{ task_execution.execution_data.tests_failed|default:0 }}
            </div>
            <div class="summary-item">
                <strong>Execution Time:</strong> {{ task_execution.execution_data.execution_time|default:"0s" }}
            </div>
        </div>
        <a href="{% url 'pybirdai:workflow_task' task_number=6 operation='review' %}" class="btn btn-primary">Go to Review</a>
    </div>
    {% elif task_execution.status == 'failed' %}
    <div class="alert alert-danger">
        <strong>‚úó Task Failed</strong>
        <p>{{ task_execution.error_message }}</p>
        <p>Please check the execution logs and fix any issues.</p>
    </div>
    {% elif task_execution.status == 'running' %}
    <div class="alert alert-info">
        <strong>üîÑ Execution in Progress</strong>
        <div class="execution-progress">
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: {{ task_execution.execution_data.overall_progress|default:0 }}%"></div>
            </div>
            <p class="mt-2">Current Stage: {{ task_execution.execution_data.current_stage|default:"Initializing..." }}</p>
            {% if task_execution.execution_data.current_test %}
            <p>Running: {{ task_execution.execution_data.current_test }}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <h2>Execution Pipeline</h2>
    
    <div class="pipeline-stages">
        <div class="stage-card">
            <div class="stage-header">
                <h3>1. Data Loading & Validation</h3>
                {% if task_execution.execution_data.data_loading_complete %}
                <span class="status-badge completed">‚úì Completed</span>
                {% elif task_execution.status == 'running' and task_execution.execution_data.current_stage == 'data_loading' %}
                <span class="status-badge running">üîÑ Running</span>
                {% else %}
                <span class="status-badge pending">‚è≥ Pending</span>
                {% endif %}
            </div>
            <div class="stage-content">
                <ul>
                    <li>Load input data files</li>
                    <li>Validate data formats</li>
                    <li>Check data integrity</li>
                    <li>Create data snapshots</li>
                </ul>
                {% if task_execution.execution_data.data_loading_complete %}
                <div class="stage-metrics">
                    <span class="metric">Files Loaded: {{ task_execution.execution_data.files_loaded|default:0 }}</span>
                    <span class="metric">Records: {{ task_execution.execution_data.total_records|default:0 }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="stage-card">
            <div class="stage-header">
                <h3>2. Filter Execution</h3>
                {% if task_execution.execution_data.filter_execution_complete %}
                <span class="status-badge completed">‚úì Completed</span>
                {% elif task_execution.status == 'running' and task_execution.execution_data.current_stage == 'filter_execution' %}
                <span class="status-badge running">üîÑ Running</span>
                {% else %}
                <span class="status-badge pending">‚è≥ Pending</span>
                {% endif %}
            </div>
            <div class="stage-content">
                <ul>
                    <li>Apply business rule filters</li>
                    <li>Execute data quality filters</li>
                    <li>Run validation filters</li>
                    <li>Generate filter reports</li>
                </ul>
                {% if task_execution.execution_data.filter_execution_complete %}
                <div class="stage-metrics">
                    <span class="metric">Filters Applied: {{ task_execution.execution_data.filters_applied|default:0 }}</span>
                    <span class="metric">Records Filtered: {{ task_execution.execution_data.records_filtered|default:0 }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="stage-card">
            <div class="stage-header">
                <h3>3. Join Operations</h3>
                {% if task_execution.execution_data.join_execution_complete %}
                <span class="status-badge completed">‚úì Completed</span>
                {% elif task_execution.status == 'running' and task_execution.execution_data.current_stage == 'join_execution' %}
                <span class="status-badge running">üîÑ Running</span>
                {% else %}
                <span class="status-badge pending">‚è≥ Pending</span>
                {% endif %}
            </div>
            <div class="stage-content">
                <ul>
                    <li>Execute data joins</li>
                    <li>Merge related datasets</li>
                    <li>Validate join integrity</li>
                    <li>Handle join conflicts</li>
                </ul>
                {% if task_execution.execution_data.join_execution_complete %}
                <div class="stage-metrics">
                    <span class="metric">Joins Executed: {{ task_execution.execution_data.joins_executed|default:0 }}</span>
                    <span class="metric">Tables Merged: {{ task_execution.execution_data.tables_merged|default:0 }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="stage-card">
            <div class="stage-header">
                <h3>4. Transformation Processing</h3>
                {% if task_execution.execution_data.transformation_complete %}
                <span class="status-badge completed">‚úì Completed</span>
                {% elif task_execution.status == 'running' and task_execution.execution_data.current_stage == 'transformation' %}
                <span class="status-badge running">üîÑ Running</span>
                {% else %}
                <span class="status-badge pending">‚è≥ Pending</span>
                {% endif %}
            </div>
            <div class="stage-content">
                <ul>
                    <li>Execute calculation rules</li>
                    <li>Perform aggregations</li>
                    <li>Generate derived measures</li>
                    <li>Apply business logic</li>
                </ul>
                {% if task_execution.execution_data.transformation_complete %}
                <div class="stage-metrics">
                    <span class="metric">Transformations: {{ task_execution.execution_data.transformations_applied|default:0 }}</span>
                    <span class="metric">Calculations: {{ task_execution.execution_data.calculations_performed|default:0 }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="stage-card">
            <div class="stage-header">
                <h3>5. Report Generation</h3>
                {% if task_execution.execution_data.report_generation_complete %}
                <span class="status-badge completed">‚úì Completed</span>
                {% elif task_execution.status == 'running' and task_execution.execution_data.current_stage == 'report_generation' %}
                <span class="status-badge running">üîÑ Running</span>
                {% else %}
                <span class="status-badge pending">‚è≥ Pending</span>
                {% endif %}
            </div>
            <div class="stage-content">
                <ul>
                    <li>Generate FINREP reports</li>
                    <li>Create validation reports</li>
                    <li>Build quality reports</li>
                    <li>Export results</li>
                </ul>
                {% if task_execution.execution_data.report_generation_complete %}
                <div class="stage-metrics">
                    <span class="metric">Reports Generated: {{ task_execution.execution_data.reports_generated|default:0 }}</span>
                    <span class="metric">Export Files: {{ task_execution.execution_data.export_files|default:0 }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="stage-card">
            <div class="stage-header">
                <h3>6. Test Suite Execution</h3>
                {% if task_execution.execution_data.test_suite_complete %}
                <span class="status-badge completed">‚úì Completed</span>
                {% elif task_execution.status == 'running' and task_execution.execution_data.current_stage == 'test_suite' %}
                <span class="status-badge running">üîÑ Running</span>
                {% else %}
                <span class="status-badge pending">‚è≥ Pending</span>
                {% endif %}
            </div>
            <div class="stage-content">
                <ul>
                    <li>Run unit tests</li>
                    <li>Execute integration tests</li>
                    <li>Perform validation tests</li>
                    <li>Generate test reports</li>
                </ul>
                {% if task_execution.status == 'running' and task_execution.execution_data.current_stage == 'test_suite' %}
                <div class="test-progress">
                    <div class="test-counter">
                        Tests: {{ task_execution.execution_data.tests_completed|default:0 }} / {{ task_execution.execution_data.total_tests|default:0 }}
                    </div>
                    <div class="test-status">
                        <span class="test-passed">‚úì {{ task_execution.execution_data.tests_passed|default:0 }}</span>
                        <span class="test-failed">‚úó {{ task_execution.execution_data.tests_failed|default:0 }}</span>
                        <span class="test-skipped">‚äù {{ task_execution.execution_data.tests_skipped|default:0 }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if task_execution.status == 'pending' %}
    <form method="post" style="margin-top: 30px;">
        {% csrf_token %}
        
        <div class="execution-config">
            <h3>Execution Configuration</h3>
            
            <div class="config-section">
                <h4>Test Configuration</h4>
                <div class="form-group">
                    <label for="test_mode">Test Mode:</label>
                    <select name="test_mode" id="test_mode" class="form-control">
                        <option value="full" selected>Full Test Suite</option>
                        <option value="smoke">Smoke Tests Only</option>
                        <option value="critical">Critical Tests Only</option>
                        <option value="custom">Custom Test Selection</option>
                    </select>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="fail_fast" id="fail_fast">
                    <label class="form-check-label" for="fail_fast">
                        Stop on first failure (fail-fast mode)
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="generate_coverage" id="generate_coverage" checked>
                    <label class="form-check-label" for="generate_coverage">
                        Generate code coverage report
                    </label>
                </div>
            </div>
            
            <div class="config-section">
                <h4>Execution Options</h4>
                <div class="form-group">
                    <label for="batch_size">Batch Size:</label>
                    <input type="number" name="batch_size" id="batch_size" class="form-control" value="10000" min="1000" max="100000">
                    <small class="form-text text-muted">Number of records to process in each batch</small>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="enable_profiling" id="enable_profiling">
                    <label class="form-check-label" for="enable_profiling">
                        Enable performance profiling
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="save_intermediate" id="save_intermediate" checked>
                    <label class="form-check-label" for="save_intermediate">
                        Save intermediate results
                    </label>
                </div>
            </div>
            
            <div class="config-section">
                <h4>Output Options</h4>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="generate_excel" id="generate_excel" checked>
                    <label class="form-check-label" for="generate_excel">
                        Generate Excel reports
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="generate_pdf" id="generate_pdf">
                    <label class="form-check-label" for="generate_pdf">
                        Generate PDF reports
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="generate_xml" id="generate_xml" checked>
                    <label class="form-check-label" for="generate_xml">
                        Generate XML output (XBRL format)
                    </label>
                </div>
            </div>
        </div>
        
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Important:</strong> Full execution may take several minutes to hours depending on data volume and selected options.
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg">Start Full Execution</button>
        <a href="{% url 'pybirdai:workflow_dashboard' %}" class="btn btn-secondary">Cancel</a>
    </form>
    {% endif %}
</div>

<style>
.execution-summary {
    display: flex;
    gap: 20px;
    margin: 15px 0;
}

.summary-item {
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: 4px;
}

.pipeline-stages {
    margin: 20px 0;
}

.stage-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    overflow: hidden;
}

.stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: white;
    border-bottom: 1px solid #dee2e6;
}

.stage-header h3 {
    margin: 0;
    color: #495057;
}

.stage-content {
    padding: 20px;
}

.stage-content ul {
    margin: 0 0 15px 0;
    padding-left: 20px;
    color: #6c757d;
}

.stage-metrics {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.metric {
    padding: 5px 10px;
    background: white;
    border-radius: 4px;
    font-size: 14px;
}

.test-progress {
    margin-top: 15px;
    padding: 15px;
    background: white;
    border-radius: 4px;
}

.test-counter {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
}

.test-status {
    display: flex;
    gap: 15px;
}

.test-passed {
    color: #198754;
}

.test-failed {
    color: #dc3545;
}

.test-skipped {
    color: #6c757d;
}

.execution-config {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.config-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #dee2e6;
}

.config-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.config-section h4 {
    margin-bottom: 15px;
    color: #495057;
}

.execution-progress {
    margin-top: 15px;
}
</style>

<script>
// Auto-refresh if task is running
{% if task_execution.status == 'running' %}
setTimeout(function() {
    location.reload();
}, 2000);
{% endif %}
</script>
{% endblock %}